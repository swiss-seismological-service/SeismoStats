import numpy as np
from numpy.testing import assert_almost_equal

from seismostats.analysis.lilliefors import ks_test_gr_lilliefors
from seismostats.utils.simulate_distributions import simulate_magnitudes_binned

MAGNITUDES = np.array([
    1.21491249, 1.44114062, 1.51737714, 1.00784803, 1.013938, 2.0093473,
    1.16893682, 1.2042688, 1.66675196, 1.03706819, 1.24850454, 1.17022059,
    1.21865948, 1.80643371, 1.04410488, 1.17911623, 1.79376588, 1.13761417,
    1.61077095, 1.20566149, 1.60634916, 1.09767713, 1.1243414, 1.07060495,
    1.33695386, 1.72111887, 1.09961136, 1.24483637, 2.28132763, 1.04888781,
    1.07441986, 1.09200887, 1.10563173, 1.30330709, 2.39473806, 1.04682204,
    2.1826222, 1.09525682, 1.2022313, 1.17511025, 1.12152914, 1.423696,
    1.20890243, 1.37462098, 1.12221124, 1.02068854, 1.42379598, 1.01617422,
    1.25000906, 1.29018644, 1.69773756, 1.0522546, 2.90664256, 1.21537743,
    1.11555627, 1.70334572, 1.28191999, 2.19565985, 1.68230201, 1.50290231,
    1.07948155, 1.6693659, 1.06210282, 1.41624718, 1.10659624, 1.40712201,
    1.03430408, 1.5799559, 1.24803266, 1.2215829, 2.83748258, 4.14292938,
    1.33755524, 1.36189619, 1.50764036, 1.27691602, 1.67463659, 1.31744524,
    1.60066112, 1.13525091, 2.61702857, 1.40565947, 1.24099701, 1.02194153,
    1.05379022, 1.14243632, 1.88634258, 1.21977854, 1.04963924, 1.30681811,
    1.04642344, 2.24123349, 1.37323459, 1.27984813, 1.32139904, 1.60588891,
    1.08760629, 2.53689332, 1.52704622, 1.75403544
])


def test_lilliefors():
    """
    Test the Lilliefors test for the Gutenberg-Richter distribution.
    """
    b = 1.0
    mc = 1.0
    magnitudes = simulate_magnitudes_binned(
        n=100, b=b, mc=mc, delta_m=0)

    # case 1: mc too high
    with np.testing.assert_raises(ValueError):
        ks_test_gr_lilliefors(magnitudes, mc=mc + 1)

    # case 2: known p_lilliefors
    p_val = ks_test_gr_lilliefors(MAGNITUDES, mc=mc)
    assert_almost_equal(p_val, 0.6620598093581814)
